<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aeho.demo.dao.BoardDao">
  <select id="listBoard" resultType="com.aeho.demo.vo.BoardVo">
  	select *from board
  </select>
  
  <select id="getBoard" resultType="com.aeho.demo.vo.BoardVo">
  	select *from board where b_no=#{b_no}
  </select>
  
  <select id="listCatBoard" resultType="com.aeho.demo.vo.BoardVo">
  	select *from board b, category c where b.c_no=c.c_no and c.c_dist = #{catkeyword}
  </select>
  
  <sql id="searchSql">
  	<choose>
  		<when test="searchField != null and !searchField.equals('') and searchField.equals('all')">
			and (b_title like '%'||#{keyword}||'%' or b_content like '%'||#{keyword}||'%' or m_id like '%'||#{keyword}||'%')
		</when>
		<when test="searchField != null and !searchField.equals('') and (searchField.equals('b_title') or searchField.equals('b_content') or searchField.equals('m_id'))">
			and ${searchField} like '%'||#{keyword}||'%'
		</when>
		<when test="searchField != null and !searchField.equals('') and searchField.equals('doc')">
			and (b_title like '%'||#{keyword}||'%' or b_content like '%'||#{keyword}||'%')
		</when>
  	</choose>
  </sql>
  
  <select id="getListWithPaging" resultType="com.aeho.demo.vo.BoardVo">
  	<![CDATA[
  		select
  			b_no, m_id, c_no, b_title, b_content, b_date, b_updatedate, b_hit, b_replycnt, b_lovecnt, b_hatecnt, b_reportcnt
  		from
  			(
  				select /*+ INDEX_DESC(board pk_board)*/
  					rownum rn, b_no, m_id, c_no, b_title, b_content, b_date, b_updatedate, b_hit, b_replycnt, b_lovecnt, b_hatecnt, b_reportcnt
  				from board
  				where rownum <= #{pageNum} * #{amount} 
  				]]>
  				<choose>
  					<when test="categoryNum != 0">
  						and c_no=#{categoryNum}
  					</when>
  					<when test="categoryNum == 0">
  						and b_reportcnt >= 5
  					</when>
  				</choose>
  				<include refid="searchSql"></include>
  	<![CDATA[
  			)
  		where rn > (#{pageNum}-1) * #{amount}  
  	]]>
  </select>  
  
  <select id="getTotalCount" resultType="int">
  	select count(*) from board where b_no>0 and c_no=#{categoryNum} <include refid="searchSql"></include>
  </select>
  
  <!-- 신고수가 많은 게시물 -->
  <select id="getReportCount" resultType="int">
  	select count(*) from board where b_reportcnt>=5
  </select>
  
  <insert id="insertBoard">
  	<selectKey keyProperty="b_no" order="BEFORE" resultType="int">
  		select seq_board.nextval from dual
  	</selectKey>
  	insert into board(b_no, m_id, c_no, b_title, b_content, b_hit, b_replycnt, b_lovecnt, b_hatecnt)
  	values(#{b_no},#{m_id},#{c_no},#{b_title},#{b_content},0,0,0,0)
  </insert>
  
  <update id="updateBoard">
  	update board set b_title = #{b_title}, b_content=#{b_content}, b_updatedate=sysdate
  	where b_no=#{b_no}
  </update>
  
  <update id="updateCnt">
  	update board set
  	<choose>
	  	<when test="cntkeyword != null and cntkeyword.equals('love')">
	  		b_lovecnt = (select count(*) from love where b_no = #{b_no})
	  	</when>
	  	<when test="cntkeyword != null and cntkeyword.equals('hate')">
	  		b_hatecnt = (select count(*) from hate where b_no = #{b_no})
	  	</when>
	  	<when test="cntkeyword != null and cntkeyword.equals('hit')">
	  		b_hit = b_hit + 1
	  	</when>
	  	<when test="cntkeyword != null and cntkeyword.equals('reply')">
	  		b_replycnt = (select count(*) from reply where b_no = #{b_no} and r_state != 1)
	  	</when>
	  	<when test="cntkeyword != null and cntkeyword.equals('report')">
	  		b_reprotcnt = b_reportcnt+1
	  	</when>
  	</choose>
  	where b_no = #{b_no}
  </update>
  
  <!-- 시큐리티시  id 추가. -->
  <delete id="deleteBoard">
  	delete board where b_no=#{b_no}
  </delete>
  
</mapper>